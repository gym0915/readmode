Transcript 抄本
[00:00] Let's see if we can use an agent to optimize this function, which is about 100 lines of calculating order prices. So I'm going to open a new Composer session and I'm going to at mention calculate order prices. And the first thing I want the agent to do is please write a suite of 10 unit tests covering various scenarios of calculate order prices so that I can confidently make changes to the code when I attempt to refactor it for performance in the future. We'll paste that in, I'll switch this to agent mode, and I don't have any tests set up yet. So once I hit submit hopefully it'll set up the dependencies and the tests and everything we need to get this covered.[00：00] 让我们看看是否可以使用代理来优化此功能，大约有 100 行计算订单价格。因此，我将打开一个新的 Composer 会话，并提及计算订单价格。我希望代理做的第一件事是请编写一套 10 个单元测试，涵盖计算订单价格的各种场景，以便我可以在将来尝试重构代码以提高性能时自信地更改代码。我们将它粘贴到其中，我将它切换到代理模式，我还没有设置任何测试。因此，一旦我点击提交，希望它能设置依赖项和测试以及我们所需的一切。
[00:40] Always make sure to review at least a little bit what it's doing here. You can see the test that it wrote and everything looks pretty good to me. I'm going to go ahead and accept and then scroll back down and I'm going to ask it to please install all the necessary dependencies and run the tests for me. If any of the tests fail please fix them. Hit submit again.[00：40] 请务必至少回顾一下它在这里的作用。你可以看到它编写的测试，在我看来一切都很好。我将继续接受，然后向下滚动，我将要求它安装所有必要的依赖项并为我运行测试。如果任何测试失败，请修复它们。再次点击 submit。
[01:01] Now it's going to be able to run terminal commands. So I'll accept that, hit that run, and then it did notice that I hadn't exported calculateOrderPrices yet, which it definitely needed to do. I don't know why it's trying to modify existing code here, or trying to modify my tsconfig, So I'm going to call it out on that. I already have a tsconfig and a vtconfig and please don't make any modifications to code other than just adding exports so that functions are accessible for tests. We'll hit submit again and hopefully it will do better this time.[01：01] 现在，它将能够运行终端命令。所以我接受了这一点，点击了该运行，然后它确实注意到我还没有导出 calculateOrderPrices，它肯定需要这样做。我不知道为什么它要修改这里的现有代码，或者要修改我的 tsconfig，所以我要把它说出来。我已经有一个 tsconfig 和一个 vtconfig，请不要对代码进行任何修改，除了添加导出以便测试可以访问函数之外。我们将再次点击 submit，希望这次它会做得更好。
[01:35] It did apologize which is always silly from an AI and I think it might have taken me too literally around exporting the functions and declared globals to get around it. So let's try avoid declaring globals. Instead you can export whatever you need from the server file, just don't modify any of the objects. Hit submit again and this is looking better now. Let's go ahead and accept that.[01：35] 它确实道歉了，这对 AI 来说总是很愚蠢的，我认为它可能让我从字面上导出函数并声明全局变量来绕过它。因此，让我们尽量避免声明 globals。相反，您可以从服务器文件中导出所需的任何内容，只是不要修改任何对象。再次点击提交，现在看起来好多了。让我们继续接受这一点。
[02:01] I actually hadn't looked at the test and maybe the tests were using globals because I had not exported that. So that would explain why it went off on that weird tangent. Let's accept those changes to the tests. And now we've arrived at this step. As you can see it highlighted here.[02：01] 我实际上没有查看测试，也许测试使用的是全局变量，因为我没有导出它。所以这就可以解释为什么它会在那个奇怪的切线上发生。让我们接受对测试的这些更改。现在我们已经到了这一步。如您所见，它在此处突出显示。
[02:15] We'll go ahead and run the command to install the necessary packages for testing. The package.json is already initialized so this probably won't fix it but maybe there's something I don't know. It's trying to use yarn instead. I wonder if I can have it read this error log. I did a quick Google search and it looks like since I used pnpm to set up the project and it's trying to use npm the solution is to always use pnpm.[02：15] 我们将继续运行命令以安装用于测试的必要包。package.json 已经初始化，所以这可能无法修复它，但也许有一些我不知道的事情。它试图改用 yarn。我想知道我是否可以让它读取这个错误日志。我做了一个快速的 Google 搜索，看起来既然我使用 pnpm 来设置项目并且它正在尝试使用 npm，那么解决方案是始终使用 pnpm。
[02:45] This error only happens when you start with pnpm and then you switch to npm. So let's run this. And now it ran the tests and it should notice that the test failed and suggest, there we go, and suggest some changes for us. And it looks like they're all based on math. So I'm going to accept these changes.[02：45] 仅当以 pnpm 开头，然后切换到 npm 时，才会发生此错误。所以让我们运行这个。现在它运行了测试，它应该注意到测试失败并建议，我们开始吧，并为我们提出一些更改建议。看起来它们都是基于数学的。所以我要接受这些变化。
[03:02] You can tell again by that purple box. And now it's down here. I'm going to run the command. Something's taking a while so I'm going to pop out the terminal. Not sure what happened so let's try running it again.[03：02] 你可以通过那个紫色框再次看出。现在它就在这里。我要运行该命令。有些事情需要一段时间，所以我要弹出终端。不确定发生了什么，所以让我们尝试再次运行它。
[03:11] What it looks like or smells like is that my tests are being watched rather than running one time and so that each time I run a new command it's starting a new file watcher. So if I get a chance to interrupt the agent I'll tell it that. Let's go ahead and accept and before running this I'm gonna tell it I think the tests are running in watch mode. Can you set up a way so that they only run once so that when you ask me to run commands it doesn't leave a process open watching for files to change. Hit submit here.[03：11] 它的外观或味道是我的测试被监视，而不是运行一次，因此每次我运行新命令时，它都会启动一个新的文件观察程序。所以，如果我有机会打断代理，我会告诉它。让我们继续接受，在运行之前，我要告诉它我认为测试是在 watch 模式下运行的。您能否设置一种方法，使它们只运行一次，这样当您要求我运行命令时，它不会让进程打开以监视文件更改。点击 submit here （在此处提交）。
[03:43] All right let's run this. Pop this out to see what it did. Looks like it's still watching for files to change. Yeah, it does need a flag and not just kind of an argument. So let's run that.[03：43] 好，我们来运行这个。弹出此内容以查看其作用。看起来它仍在监视文件更改。是的，它确实需要一个标志，而不仅仅是一个参数。所以让我们运行它。
[03:54] There we go, much better. I'm not sure what it's asking me to accept right here. Maybe just to finalize and apply the changes. I'm going to come in and make sure I close out any running terminals just with a little trash can or command backspace. And we can move on to the next phase of our plan now that this is tested.[03：54] 好多了。我不确定它在这里要求我接受什么。也许只是为了完成并应用更改。我要进来，确保我只用一个小垃圾桶或命令退格键关闭所有正在运行的终端。既然这已经过测试，我们可以继续我们计划的下一阶段。
[04:16] So we'll go ahead and create a new composer session. I'll select this block of code, hit command-I to drop that into our composer session, or you could type at and then type the name of the function, both ways work. Make sure we're on agent. Please create a performance.test.ts file with five performance scenarios on the calculate order prices function so that we can begin benchmarking this function. Add a way to run the benchmark inside of a package.json and also set up a way to track the benching history or track the benchmarking history that we can see improvements or regressions over time.[04：16] 我们将继续创建一个新的作曲家会话。我将选择此代码块，按 command-I 将其拖放到我们的 Composer 会话中，或者您可以键入 at 然后键入函数的名称，这两种方式都可以。确保我们是代理。请在 calculate order prices 函数上创建一个包含五个性能场景的 performance.test.ts 文件，以便我们可以开始对此函数进行基准测试。添加一种方法来在 package.json 中运行基准测试，并设置一种方法来跟踪替补历史或跟踪基准测试历史，我们可以看到随着时间的推移而改进或回归。
[04:50] So we'll make sure we're on agent, hit submit. Looks like it's doing some general inspection. Let's go ahead and accept it and allow it to benchmark. Looks like it's going to log benchmark results in a readme. What's going on in here?[04：50] 我们将确保我们处于代理状态，点击提交。看起来它正在进行一些一般检查。让我们继续接受它并让它进行基准测试。看起来它将在自述文件中记录基准测试结果。这是怎么回事？
[05:07] Create a directory for it and let's go ahead and run this command. It should notice the error here and suggest a fix. Yep it found a file naming convention that didn't match. And it looks like the file name that I requested didn't match the way that VTest typically handles benchmarking. So I'll allow that to happen.[05：07] 为其创建一个目录，然后让我们继续运行此命令。它应该会注意到这里的错误并建议修复。是的，它发现了一个不匹配的文件命名约定。而且，我请求的文件名似乎与 VTest 通常处理基准测试的方式不匹配。所以我会允许这种情况发生。
[05:25] I'll accept this and now let's try running again. And it does look like a pattern I need to get used to is always telling it to use pnpm. I'll have to make sure and add that to my cursor rules. And this is taking a while, it might be... Let's see...[05：25] 我接受这个，现在让我们再次尝试运行。看起来我确实需要习惯的一种模式是总是告诉它使用 pnpm。我必须确保并将其添加到我的光标规则中。这需要一段时间，可能是......我看看。。。
[05:40] I don't see any results output. So let's read through this. I'm going to tell it, I'm going to copy and paste this, paste it in here, and say I've noticed two things. One, this command starts a file watching mode. Please make it like a single run mode.[05：40] 我没有看到任何结果输出。所以让我们通读一下。我要告诉它，我要复制并粘贴这个，把它粘贴到这里，然后说我注意到了两件事。第一，此命令启动文件监视模式。请将其设置为单运行模式。
[05:56] And two, I don't see any output in the bench section or the summary section telling me how fast this is running. Please fix these for me. All right so it's adding that run flag to benchmark. Let's accept that. I honestly didn't even look at the output of server bench before.[05：56] 第二，我在 bench 部分或摘要部分没有看到任何输出告诉我它的运行速度有多快。请帮我修复这些问题。好的，所以它把那个 run 标志添加到 benchmark 中。让我们接受这一点。老实说，我以前甚至没有看过 server bench 的输出。
[06:14] So let's accept that. Let's run the benchmark. And looks like we're getting some results. So now it looks like we're in a good spot to start our new composer session. Let's make sure and exit this out.[06：14] 那么，让我们接受这一点。让我们运行基准测试。看起来我们得到了一些结果。所以现在看起来我们处于开始新作曲家会议的好时机。让我们确保并退出它。
[06:28] We don't need that file watcher running. And what I want to do is with this function, so in my new session take this function, hit command-I to drop it into my composer session, and I'll say generate three variations of this function that are optimized for performance. Make sure that each of them are run against the unit tests in the project and the benchmarks in the project. Always run the unit test first so that it fails quickly, and then run the benchmarks, and then report back which of the three variations is the fastest. Then we'll let this run, And it's going through and making all of these variations for me.[06：28] 我们不需要运行该文件观察程序。我想做的是这个函数，所以在我的新会话中，使用这个函数，按 command-I 将其放入我的作曲家会话中，然后我说生成这个函数的三个变体，它们针对性能进行了优化。确保它们中的每一个都针对项目中的单元测试和项目中的基准测试运行。始终先运行 Unit Test，以便它快速失败，然后运行基准测试，然后报告三个变体中的哪一个最快。然后我们让它运行，它正在为我进行并制作所有这些变化。
[07:07] So there's variation B, let's see variation C. I'm going to accept all, and I'm going to ask it to please run the unit tests and then the benchmarks against each of these variations and track which one is fastest. We'll hit submit here, always making sure agent is selected. Sometimes it's easy to miss that and you'll find this happens a lot where you're trying to get work done and it finds linter errors and it tackles those first, which can be a little bit frustrating since the linter errors are not as important as the task at hand. I haven't found a way around that yet.[07：07] 有变体 B，让我们看看变体 C。我将接受所有变体，并要求它运行单元测试，然后针对每个变体运行基准测试，并跟踪哪个最快。我们将在此处点击 submit （提交），始终确保 agent 被选中。有时很容易错过这一点，你会发现这种情况经常发生，当你试图完成工作时，它会发现 Linter 错误并首先解决这些错误，这可能有点令人沮丧，因为 Linter 错误不如手头的任务重要。我还没有找到解决这个问题的方法。
[07:40] So all right let's accept the changes for the linter errors. I'm not sure if it set up the test correctly to run all the variations, but we'll run it and see what happens. At this point I'm not sure if I should tell it there is a package.json. Yeah it dug into it before I could tell it that it existed. So let's accept and run.[07：40] 好了，让我们接受 linter 错误的更改。我不确定它是否正确地设置了测试以运行所有变体，但我们会运行它，看看会发生什么。在这一点上，我不确定我是否应该告诉它有一个package.json。是的，在我能告诉它存在之前，它就深入研究了它。所以让我们接受并运行。
[08:00] And the thing that I want to check here is I want to make sure it's running the unit tests against every variation. And I didn't see that happen. So I'm going to interject here. I don't see the unit tests running against every variation of our function that we're trying to benchmark. Please review the work so far and make sure that we're testing all of the variations and then we benchmark them.[08：00] 我在这里要检查的是，我想确保它针对每个变体运行单元测试。我没有看到这种情况发生。所以我要在这里插一句。我没有看到针对我们尝试进行基准测试的函数的每个变体运行单元测试。请查看到目前为止的工作，并确保我们正在测试所有变体，然后对它们进行基准测试。
[08:22] It is critical that each of their variations pass the unit tests before we benchmark them. So we'll submit this and ignore this command. Alright so now it's going to test to test all variations. All right let's accept this and then run our tests. It noticed what had failed, the variations weren't being exported, so let's accept that and run the tests again.[08：22] 在对它们进行基准测试之前，其每个变体都必须通过单元测试，这一点至关重要。因此，我们将提交此命令并忽略此命令。好了，现在要测试所有变体。好了，让我们接受这个，然后运行我们的测试。它注意到了失败的内容，没有导出变体，所以让我们接受这一点并再次运行测试。
[08:44] And now it looks like it needs to sync up the variations with what's being called in the test. Now the variations not being properly defined is something I would have expected it to get right and I'm trying to think back to what I could have said or done differently. How I could have injected myself into the process earlier to avoid this, like explicitly saying please make sure the variations are defined in the test. Essentially every time you go through one of these agent loops you're going to be learning and experience is the best teacher here. Alright let's accept all the changes, run the benchmark.[08：44] 现在看起来它需要将变体与测试中调用的内容同步。现在，没有正确定义的变化是我期望它会正确的事情，我正在努力回想我本可以说什么或做什么不同的事情。我如何更早地将自己注入到流程中以避免这种情况，比如明确说请确保在测试中定义了变体。基本上，每次你经历这些代理循环之一时，你都会学习和体验，这是这里最好的老师。好了，让我们接受所有更改，运行基准测试。
[09:16] Oh it didn't ask me to run the tests so I'm gonna have to inject myself in there. Always run the tests before running the benchmarks. And this is starting to feel like one of those days where the AI model is just being dumb. Seeing it do much better work than this. So I'm seriously questioning if there's something going on on the back end with the Claude model right now.[09：16] 哦，它没有要求我运行测试，所以我必须将自己注射到其中。始终在运行基准测试之前运行测试。这开始感觉像是 AI 模型变得愚蠢的日子之一。看到它做得比这好得多。所以我认真地质疑 Claude 模型的后端现在是否发生了一些事情。
[09:38] All right we'll accept the test changes, we'll accept the benchmark changes. Okay now let's run the tests. Still have lots of failures. The variations are still not being defined. Okay now we're exporting them so let's accept that.[09：38] 好的，我们将接受测试更改，我们将接受基准测试更改。好了，现在让我们运行测试。仍然有很多失败。变体仍未定义。好了，现在我们正在导出它们，所以让我们接受它。
[09:52] Often I'm about to go look and see what was wrong but then it goes and finds what's wrong first before I even get a chance to, which puts me as the user in a weird space where it kind of beats me in a race to finding what needs to be fixed. All right so I accepted the changes to the tests, we'll give it another try. All right so the original implementation is working, it's going to create new files for the variations. All right so we have a variations file which we'll accept now. It's like it has each of the different options and now it's going to test the variations as well and we'll run this to test them.[09：52] 我经常想去看看出了什么问题，但后来它甚至在我有机会之前就先发现了哪里出了问题，这让我作为用户处于一个奇怪的空间中，在寻找需要修复的问题的竞赛中，它有点击败了我。好了，我接受了对测试的更改，我们再试一次。好了，原始实现可以正常工作，它将为变体创建新文件。好了，我们有一个变体文件，我们现在接受它。就像它有每个不同的选项一样，现在它也将测试变体，我们将运行它来测试它们。
[10:23] And it looks like all the tests passed. I just want to check here to make sure it's actually importing variations. So it is bringing in each of the variations so that looks good. And if we look for implementations you can see it's running the implementations for the original. Is it running variation A?[10：23] 看起来所有测试都通过了。我只想在这里检查以确保它确实在导入变体。所以它引入了每个变体，所以看起来不错。如果我们查找 implementations，你可以看到它正在运行原始的 implementations。是运行变体 A 吗？
[10:42] I don't think it is running variation A. I'm going to accept this but I'm also going to say in the test it doesn't look like it's running the variations it looks like it's only running the original. Am I wrong? If I'm right please correct it so that it runs the original and all the variations. We'll submit this.[10：42] 我不认为这是在运行变体 A。我将接受这一点，但我也要说，在测试中，它看起来不像是在运行变体，它看起来只是在运行原始变体。我错了吗？如果我是对的，请更正它，以便它运行原始和所有变体。我们将提交此文件。
[10:59] This is honestly a huge oversight based on what we were doing. And I'm beginning to think that AI is just laughing at me because it knows I'm recording and we're going to run the test. The test failed. And this is good news for us. It recognizes variation B is failing a test and Variation C is failing a test.[10：59] 老实说，根据我们所做的工作，这是一个巨大的疏忽。我开始认为 AI 只是在嘲笑我，因为它知道我在录制，我们要运行测试。测试失败。这对我们来说是个好消息。它识别出变体 B 未通过测试，而变体 C 未通过测试。
[11:16] So this is definitely saving me a ton of work right there. So let's accept the changes, run the command again. We're down to one failed test in variation B. So we can accept this, run the tests again, and everything passes. So now it's time, if it remembers, it's time to benchmark.[11：16] 这绝对为我节省了大量工作。因此，让我们接受更改，再次运行命令。我们只剩下变体 B 中的一个失败测试。所以我们可以接受这一点，再次运行测试，一切都通过了。所以现在是时候了，如果它还记得的话，是时候进行基准测试了。
[11:36] So let's see what happens. I'm going to pop this out in case there's, yeah I thought there might be a bunch of stuff running, and I'm honestly not sure if this has access to all of the results. So I'm gonna ask it, do you have access to all of the results from the benchmark? If yes, select the fastest variation and explain why you selected it. If it doesn't have access I can just copy and paste from my terminal here.[11：36] 让我们看看会发生什么。我要弹出这个以防万一，是的，我认为可能会有一堆东西正在运行，老实说，我不确定这是否可以访问所有结果。所以我要问它，您是否可以访问基准测试的所有结果？如果是，请选择最快的变体并说明您选择它的原因。如果它没有访问权限，我可以从我的终端复制和粘贴。
[12:07] Looks like an API failed we'll just run it again. Looks like the API is still failing. Let's just open a chat with the results just to kind of wrap this up. Let's say add to chat and I'm going to add the code base. Based on the performance results from the terminal please select the fastest variation whether it's the original or one of the variations as the most performant version, explain why it's the most performant version, and give us a brief comparison to the other versions.[12：07] 看起来 API 失败了，我们将再次运行它。看起来 API 仍然失败。让我们打开一个包含结果的聊天，只是为了总结一下。假设 add to chat，我将添加代码库。根据终端的性能结果，请选择最快的变体，无论是原始变体还是作为性能最高的版本之一，解释为什么它是性能最高的版本，并给我们简要比较一下。
[12:38] So we'll hit submit here. All right so it looks like it has variation C as the winner, about 30% faster, and you could read through all the reasons why. But in real time this took about 45 minutes while using this agent. Obviously this video is heavily edited and we've got ourself a huge performance win on this function. And setting up all of this testing, setting up all the benchmarking, even though we ran into a bunch of various failures while using the agent.[12：38] 我们在这里点击提交。好吧，看起来它有变体 C 作为赢家，速度提高了大约 30%，你可以读完所有原因。但实际上，使用此代理时，这大约需要 45 分钟。显然，这个视频经过了大量编辑，我们在此功能上取得了巨大的性能胜利。并设置所有这些测试，设置所有基准测试，即使我们在使用代理时遇到了一堆不同的故障。
[13:08] I don't really remember writing any code and this saved me a huge amount of time, huge amount of testing. It just required a little bit of patience and a little bit of reasoning when the agent kind of went in the wrong directions.[13：08] 我真的不记得写过任何代码，这为我节省了大量的时间和大量的测试。这只需要一点耐心和一点推理，当经纪人走错了方向时。